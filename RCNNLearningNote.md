# RCNN Learning Notes
=====

参考：<br>
[RCNN- 将CNN引入目标检测的开山之作](https://zhuanlan.zhihu.com/p/23006190)

[R-CNN论文详解](https://blog.csdn.net/WoPawn/article/details/52133338)

## RCNN 步骤

1. 输入一张多目标图像，采用selective search算法提取约2000个建议框；

2. 先在每个建议框周围加上16个像素值为建议框像素平均值的边框，再直接变形为227×227的大小；

3. 先将所有建议框像素减去该建议框像素平均值后【预处理操作】，再依次将每个227×227的建议框输入AlexNet CNN网络获取4096维的特征【比以前的人工经验特征低两个数量级】，2000个建议框的CNN特征组合成2000×4096维矩阵；

4. 将2000×4096维特征与20个SVM组成的权值矩阵4096×20相乘【20种分类，SVM是二分类器，则有20个SVM】，获得2000×20维矩阵表示每个建议框是某个物体类别的得分；

5. 分别对上述2000×20维矩阵中每一列即每一类进行非极大值抑制剔除重叠建议框，得到该列即该类中得分最高的一些建议框；

6. 分别用20个回归器对上述20个类别中剩余的建议框进行回归操作，最终得到每个类别的修正后的得分最高的bounding box。

## Selective Search
使用一种过分割手段，将图像分割成小区域 (1k~2k 个)，查看现有小区域，按照合并规则合并可能性最高的相邻两个区域。重复直到整张图像合并成一个区域位置。输出所有曾经存在过的区域，所谓候选区域。<br>

合并规则就是每个区域的重复度，但是我不是很明白什么样算是把整个图片合并成了一个区域位置。

## IOU重叠度

![](https://pic1.zhimg.com/80/v2-6fe13f10a9cb286f06aa1e3e2a2b29bc_hd.png)

![](https://pic1.zhimg.com/80/v2-e26ffc0835bc30dede8d82989ef9e178_hd.png)

图中的两个框框呢就是定位物体的框框，叫bounding box

## 非极大值抑制（NMS）

1. 对2000×20维矩阵中每列按从大到小进行排序； 
2. 从每列最大的得分建议框开始，分别与该列后面的得分建议框进行IoU计算，若IoU>阈值，则剔除得分较小的建议框，否则认为图像中存在多个同一类物体； 
3. 从每列次大的得分建议框开始，重复步骤②； 
4. 重复步骤③直到遍历完该列所有建议框； 
5. 遍历完2000×20维矩阵所有列，即所有物体种类都做一遍非极大值抑制； 
6. 最后剔除各个类别中剩余建议框得分少于该类别阈值的建议框。

## 候选框搜索阶段

当我们输入一张图片时，我们要搜索出所有可能是物体的区域，这里采用的就是前面提到的Selective Search方法，通过这个算法我们搜索出2000个候选框。<br>

(这里其实不理解，为什么SS的方法可以得到矩形框？为什么可以得到多个矩形框？待会再查查其他资料吧)<br>

然后要对图片进行缩放处理，为了简单起见我们假设下一阶段CNN所需要的输入图片大小是个正方形图片227*227。因为我们经过selective search 得到的是矩形框，paper试验了两种不同的处理方法

![](https://pic2.zhimg.com/80/v2-59449e8409b943f384c4cc3bf789d8b9_hd.png)

* 各向异性缩放（D）
* 各向同性缩放-先扩充后裁剪（B）
* 各向同性缩放-先裁剪后扩充（C）

## 正负样本

一张照片我们得到了2000个候选框。然而人工标注的数据一张图片中就只标注了正确的bounding box，我们搜索出来的2000个矩形框也不可能会出现一个与人工标注完全匹配的候选框。因此在CNN阶段我们需要用IOU为2000个bounding box打标签。<br>

如果用selective search挑选出来的候选框与物体的人工标注矩形框（PASCAL VOC的图片都有人工标注）的重叠区域IoU大于0.5，那么我们就把这个候选框标注成物体类别（正样本），否则我们就把它当做背景类别（负样本）。

## SVM训练、测试阶段

这是一个二分类问题，我么假设我们要检测车辆。我们知道只有当bounding box把整量车都包含在内，那才叫正样本；如果bounding box 没有包含到车辆，那么我们就可以把它当做负样本。<br>
但问题是当我们的检测窗口只有部分包含物体，那该怎么定义正负样本呢？<br>

作者测试了IOU阈值各种方案数值0,0.1,0.2,0.3,0.4,0.5。最后通过训练发现，如果选择IOU阈值为0.3效果最好（选择为0精度下降了4个百分点，选择0.5精度下降了5个百分点）,即当重叠度小于0.3的时候，我们就把它标注为负样本。<br>

一旦CNN f7层特征被提取出来，那么我们将为每个物体类训练一个svm分类器。当我们用CNN提取2000个候选框，可以得到2000*4096这样的特征向量矩阵，然后我们只需要把这样的一个矩阵与svm权值矩阵4096*N点乘(N为分类类别数目，因为我们训练的N个svm，每个svm包含了4096个权值w)，就可以得到结果了。

## 总结
算是照着两个博客大概把RCNN弄个大概了，但是这个还只是基础的，在这个基础上要看 `Faster RCNN`，`CTPN`，`CRNN`，太可怕了何时是个头...